<VirtualHost *:80>
    	ServerAdmin webmaster@localhost
    	DocumentRoot /var/www/html

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	RewriteEngine on
	RewriteCond %{HTTPS} !=on
	RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,QSA,R=permanent]


# Following lines should open rstudio directly from the url
#        RewriteCond %{HTTP:Upgrade} =websocket
#        RewriteRule /rstudio/(.*)     ws://localhost:8787/$1  [P,L]
#        RewriteCond %{HTTP:Upgrade} !=websocket
#        RewriteRule /rstudio/(.*)     http://localhost:8787/$1 [P,L]
#        ProxyPass /rstudio/ http://localhost:8787/
#        ProxyPassReverse /rstudio/ http://localhost:8787/

</VirtualHost>

<VirtualHost *:443>
    ServerAdmin webmaster@localhost
    LogLevel info
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Include conf-available/serve-cgi-bin.conf
    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Options +ExecCGI -Indexes +Includes
        Require all granted
    </Directory>
    AddHandler cgi-script .cgi .py cgi py

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    SSLCertificateFile /etc/ca-certificates/mycert.pem
    SSLCertificateKeyFile /etc/ca-certificates/mykey.key

    ServerName localhost
    RewriteEngine on
    ProxyRequests Off
    ProxyVia On

# THIS BREAKS RSTUDIO SERVER
    #ProxyPreserveHost On

# ------------ R Studio configuration ------------ #
	Redirect /rstudio /rstudio/
	Redirect /auth-sign-in /rstudio/auth-sign-in
	Redirect /auth-sign-out /rstudio/auth-sign-out
	Redirect /s /rstudio/s
	Redirect /admin /rstudio/admin
	
	# Catch RStudio redirecting improperly from the auth-sign-in page
	<If "%{HTTP_REFERER} =~ /auth-sign-in/">
	  RedirectMatch ^/$	/rstudio/
	</If>
#Initially, we only need the code below, but because of the ProxyPreserveHost, we need the code from above also
        RewriteCond %{HTTP:Upgrade} =websocket
        RewriteRule /rstudio/(.*)     ws://localhost:8787/$1  [P,L]
        RewriteCond %{HTTP:Upgrade} !=websocket
        RewriteRule /rstudio/(.*)     http://localhost:8787/$1 [P,L]
        ProxyPass /rstudio/ http://localhost:8787/
        ProxyPassReverse /rstudio/ http://localhost:8787/
# # ------------ R Studio configuration ------------ #

# ------------ Jupyter Hub configuration --------- #
	<Location "/jupyter/">
		ProxyPreserveHost on
	</Location>
    	ProxyPass /jupyter/ https://localhost:8000/jupyter/
    	ProxyPassReverse /jupyter/ https://localhost:8000/jupyter/
    	<Location ~ "/jupyter/(user/[^/]*)/(api/kernels/[^/]+/channels|terminals/websocket)/?">
        	ProxyPass wss://localhost:8000/
        	ProxyPassReverse wss://localhost:8000/
    	</Location>
# ------------ Jupyter Hub configuration --------- #
</VirtualHost>

